<mat-card class="cardWithShadow">
  <mat-card-content>
    <mat-card-title>Arborescence des categories</mat-card-title>

    <div class="d-flex flex-wrap gap-16 m-b-16 align-items-end">
      <mat-form-field appearance="outline" class="flex-grow-1">
        <mat-label>Rechercher une catégorie</mat-label>
        <input
          matInput
          [formControl]="searchControl"
          [matAutocomplete]="auto"
          placeholder="ex: Electronique, Telephone..."
          [disabled]="isLoading"
        />
        <mat-autocomplete
          #auto="matAutocomplete"
          [displayWith]="displaySearchOption"
          (optionSelected)="onSearchSelect($event.option.value)"
        >
          @if (isSearching) {
            <mat-option class="text-muted" disabled>Recherche...</mat-option>
          }
          @for (option of searchOptions; track option.id) {
            <mat-option [value]="option">
              <div class="d-flex flex-column">
                <span>{{ option.label }}</span>
                <span class="text-muted f-s-12"
                  >/{{ option.slug }} · Niveau {{ option.niveau }}</span
                >
              </div>
            </mat-option>
          }
          @if (!isSearching && searchText.length >= 2 && !searchOptions.length) {
            <mat-option class="text-muted" disabled>Aucun resultat</mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>
      <button mat-flat-button color="primary" (click)="reload()" [disabled]="isLoading">
        Rafraichir
      </button>
      <button mat-stroked-button (click)="resetRoot()" [disabled]="isLoading || !selectedRoot">
        Tout afficher
      </button>
    </div>

    @if (selectedRoot) {
      <div class="current-root">
        Racine actuelle: <strong>{{ selectedRoot.label }}</strong>
      </div>
    }

    @if (isLoading) {
      <div class="p-16">Chargement en cours...</div>
    } @else if (errorMessage) {
      <div class="p-16 text-error">{{ errorMessage }}</div>
    } @else if (!categories.length) {
      <div class="p-16 text-muted">Aucune categorie trouvee.</div>
    } @else {
      <div class="tree-wrapper">
        <mat-tree
          class="category-tree"
          [dataSource]="dataSource"
          [treeControl]="treeControl"
          [trackBy]="trackById"
        >
          <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
            <div class="node-row">
              <span class="toggle-spacer"></span>
              <span class="node-name">{{ node.nom }}</span>
              <span class="node-slug">/{{ node.slug }}</span>
              <span
                class="node-badge"
                [matBadge]="node.childrenCount"
                matBadgeColor="primary"
                matBadgeOverlap="false"
              >
                Enfants
              </span>
              @if (node.isActive) {
                <span class="node-status text-success">Actif</span>
              } @else {
                <span class="node-status text-error">Inactif</span>
              }
              <span class="node-meta">Niveau {{ node.niveau }}</span>
              <span class="node-spacer"></span>
              <button mat-icon-button [matMenuTriggerFor]="leafMenu" aria-label="Actions categorie">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #leafMenu="matMenu">
                <button mat-menu-item (click)="setRootFromNode(node)">
                  <mat-icon>account_tree</mat-icon>
                  <span>Definir comme racine</span>
                </button>
                <button mat-menu-item (click)="openAddChildDialog(node)">
                  <mat-icon>add</mat-icon>
                  <span>Ajouter enfant</span>
                </button>
                <button mat-menu-item (click)="openEditDialog(node)">
                  <mat-icon>edit</mat-icon>
                  <span>Modifier</span>
                </button>
                <button mat-menu-item disabled matTooltip="A venir">
                  <mat-icon>drive_file_move</mat-icon>
                  <span>Deplacer</span>
                </button>
                <button
                  mat-menu-item
                  (click)="openDeleteDialog(node)"
                  [disabled]="node.childrenCount > 0"
                >
                  <mat-icon>delete</mat-icon>
                  <span>Supprimer</span>
                </button>
              </mat-menu>
            </div>
          </mat-tree-node>

          <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
            <div class="node-row">
              <button
                mat-icon-button
                class="node-toggle"
                matTreeNodeToggle
                [attr.aria-label]="'Basculer ' + node.nom"
              >
                <mat-icon>
                  {{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
                </mat-icon>
              </button>
              <span class="node-name">{{ node.nom }}</span>
              <span class="node-slug">/{{ node.slug }}</span>
              <span
                class="node-badge"
                [matBadge]="node.childrenCount"
                matBadgeColor="primary"
                matBadgeOverlap="false"
              >
                Enfants
              </span>
              @if (node.isActive) {
                <span class="node-status text-success">Actif</span>
              } @else {
                <span class="node-status text-error">Inactif</span>
              }
              <span class="node-meta">Niveau {{ node.niveau }}</span>
              <span class="node-spacer"></span>
              <button mat-icon-button [matMenuTriggerFor]="nodeMenu" aria-label="Actions categorie">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #nodeMenu="matMenu">
                <button mat-menu-item (click)="setRootFromNode(node)">
                  <mat-icon>account_tree</mat-icon>
                  <span>Definir comme racine</span>
                </button>
                <button mat-menu-item (click)="openAddChildDialog(node)">
                  <mat-icon>add</mat-icon>
                  <span>Ajouter enfant</span>
                </button>
                <button mat-menu-item (click)="openEditDialog(node)">
                  <mat-icon>edit</mat-icon>
                  <span>Modifier</span>
                </button>
                <button mat-menu-item disabled matTooltip="A venir">
                  <mat-icon>drive_file_move</mat-icon>
                  <span>Deplacer</span>
                </button>
                <button
                  mat-menu-item
                  (click)="openDeleteDialog(node)"
                  [disabled]="node.childrenCount > 0"
                >
                  <mat-icon>delete</mat-icon>
                  <span>Supprimer</span>
                </button>
              </mat-menu>
            </div>
          </mat-tree-node>
        </mat-tree>
      </div>
    }
  </mat-card-content>
</mat-card>
