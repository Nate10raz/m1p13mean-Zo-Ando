<mat-card class="cardWithShadow">
  <mat-card-content>
    <div class="d-flex flex-wrap gap-16 align-items-center justify-content-between">
      <div>
        <mat-card-title>Mise a jour du tarif</mat-card-title>
        @if (box) {
          <mat-card-subtitle class="text-muted">
            Box {{ box.numero }} · Zone {{ box.zone }} · Etage {{ box.etage }}
          </mat-card-subtitle>
        } @else {
          <mat-card-subtitle class="text-muted">Ajustez le tarif d'une box.</mat-card-subtitle>
        }
      </div>
      <button mat-stroked-button type="button" (click)="goBack()" [disabled]="isSubmitting">
        Retour
      </button>
    </div>

    @if (isLoading) {
      <div class="p-16">Chargement en cours...</div>
    } @else if (errorMessage) {
      <div class="p-16 text-error">{{ errorMessage }}</div>
    } @else {
      @if (box) {
        <div class="meta-grid m-t-16">
          <div class="meta-item">
            <div class="meta-label">Tarif actuel</div>
            <div class="meta-value">{{ formatTarif(box.tarifActuel) }}</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Debut tarif</div>
            <div class="meta-value">{{ formatDate(box.tarifActuel?.dateDebut) }}</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Statut</div>
            <div class="meta-value">{{ box.estOccupe ? 'Occupee' : 'Disponible' }}</div>
          </div>
        </div>
      }

      <form class="m-t-16" [formGroup]="form" (ngSubmit)="submit()">
        <div class="d-flex flex-wrap gap-16">
          <mat-form-field appearance="outline">
            <mat-label>Montant</mat-label>
            <input matInput type="number" step="0.01" min="0" formControlName="montant" />
            @if (form.get('montant')?.hasError('required')) {
              <mat-error>Montant requis.</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Unite</mat-label>
            <mat-select formControlName="unite">
              <mat-option value="mois">Mois</mat-option>
              <mat-option value="annee">Annee</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="flex-grow-1">
            <mat-label>Date debut</mat-label>
            <input matInput type="datetime-local" formControlName="dateDebut" />
            @if (form.get('dateDebut')?.hasError('required')) {
              <mat-error>Date debut requise.</mat-error>
            }
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="w-100 m-t-8">
          <mat-label>Raison (optionnel)</mat-label>
          <textarea
            matInput
            rows="2"
            formControlName="raison"
            placeholder="Ex: revalorisation annuelle"
          ></textarea>
        </mat-form-field>

        <div class="d-flex flex-wrap gap-12 m-t-24">
          <button
            mat-flat-button
            color="primary"
            type="submit"
            [disabled]="form.invalid || isSubmitting"
          >
            {{ isSubmitting ? 'Mise a jour...' : 'Mettre a jour' }}
          </button>
          <button mat-stroked-button type="button" (click)="goBack()" [disabled]="isSubmitting">
            Annuler
          </button>
        </div>

        @if (serverError) {
          <div class="text-error m-t-12">{{ serverError }}</div>
        }
      </form>
    }
  </mat-card-content>
</mat-card>
