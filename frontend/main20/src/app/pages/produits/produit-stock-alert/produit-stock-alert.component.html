<mat-card class="cardWithShadow">
  <mat-card-content>
    <div class="d-flex flex-wrap gap-16 align-items-center justify-content-between">
      <div>
        <mat-card-title>Seuil d'alerte stock</mat-card-title>
        <mat-card-subtitle>Configurer les seuils par produit</mat-card-subtitle>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-16 m-t-16 align-items-end">
      <mat-form-field appearance="outline" class="flex-grow-1">
        <mat-label>Recherche</mat-label>
        <input matInput [formControl]="searchControl" placeholder="Titre ou slug" />
      </mat-form-field>
    </div>

    <div class="d-flex flex-wrap gap-12 align-items-center m-t-8">
      <mat-form-field appearance="outline" class="seuil-field">
        <mat-label>Seuil en masse</mat-label>
        <input matInput type="number" min="0" [formControl]="bulkSeuilControl" />
      </mat-form-field>
      <mat-form-field appearance="outline" class="flex-grow-1">
        <mat-label>Categorie (optionnel)</mat-label>
        <mat-select [formControl]="bulkCategoryControl" [disabled]="isLoadingCategories">
          <mat-option value="">Toutes / selection manuelle</mat-option>
          @for (cat of categories; track cat._id) {
            <mat-option [value]="cat._id">{{ cat.nom }}</mat-option>
          }
        </mat-select>
        @if (isLoadingCategories) {
          <mat-hint>Chargement des categories...</mat-hint>
        }
      </mat-form-field>
      <button
        mat-flat-button
        color="primary"
        type="button"
        (click)="applyBulk()"
        [disabled]="isBulkSaving"
      >
        Appliquer
      </button>
      <span class="text-muted f-s-12">Produits selectionnes : {{ selectedCount }}</span>
    </div>
    <div class="text-muted f-s-12 m-t-4">
      Si une categorie est choisie, la mise a jour s'applique a tous ses produits.
    </div>

    @if (isLoading) {
      <div class="p-16">Chargement en cours...</div>
    } @else if (errorMessage) {
      <div class="p-16 text-error">{{ errorMessage }}</div>
    } @else if (!dataSource.length) {
      <div class="p-16 text-muted">Aucun produit trouve.</div>
    } @else {
      <div class="table-responsive">
        <table mat-table [dataSource]="dataSource" [trackBy]="trackByProductId" class="w-100">
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef class="p-l-0">
              <mat-checkbox
                [checked]="isAllSelected()"
                [indeterminate]="isIndeterminate()"
                (change)="toggleAll($event.checked)"
              ></mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let element" class="p-l-0">
              <mat-checkbox
                [checked]="element.selected"
                (change)="toggleRow(element, $event.checked)"
              >
              </mat-checkbox>
            </td>
          </ng-container>
          <ng-container matColumnDef="produit">
            <th mat-header-cell *matHeaderCellDef class="f-w-600 f-s-14 p-l-0">Produit</th>
            <td mat-cell *matCellDef="let element" class="p-l-0">
              <div class="product-cell">
                <img [src]="element.image" alt="produit" width="48" class="rounded" />
                <div class="product-info">
                  <h6 class="f-s-14 f-w-600">{{ element.titre }}</h6>
                  <span class="f-s-12 text-muted">{{ element.slug }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="stock">
            <th mat-header-cell *matHeaderCellDef class="f-w-600 f-s-14">Stock</th>
            <td mat-cell *matCellDef="let element">
              <span class="f-w-600">{{ element.quantite }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="seuil">
            <th mat-header-cell *matHeaderCellDef class="f-w-600 f-s-14">Seuil d'alerte</th>
            <td mat-cell *matCellDef="let element">
              <mat-form-field appearance="outline" class="seuil-field">
                <input
                  matInput
                  type="number"
                  min="0"
                  [value]="element.draftSeuil"
                  (input)="onDraftChange(element, $event)"
                />
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="statut">
            <th mat-header-cell *matHeaderCellDef class="f-w-600 f-s-14">Statut</th>
            <td mat-cell *matCellDef="let element">
              @if (isLowStock(element)) {
                <span class="bg-light-error text-error rounded f-w-600 p-6 p-y-4 f-s-12"
                  >Alerte</span
                >
              } @else {
                <span class="bg-light-success text-success rounded f-w-600 p-6 p-y-4 f-s-12"
                  >OK</span
                >
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="f-w-600 f-s-14"></th>
            <td mat-cell *matCellDef="let element">
              <button
                mat-flat-button
                color="primary"
                type="button"
                (click)="saveRow(element)"
                [disabled]="element.isSaving"
              >
                Enregistrer
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>

      <mat-paginator
        class="m-t-16"
        [length]="total"
        [pageIndex]="page - 1"
        [pageSize]="limit"
        [pageSizeOptions]="[5, 10, 25, 50]"
        [showFirstLastButtons]="true"
        (page)="onPageChange($event)"
      >
      </mat-paginator>
    }
  </mat-card-content>
</mat-card>
