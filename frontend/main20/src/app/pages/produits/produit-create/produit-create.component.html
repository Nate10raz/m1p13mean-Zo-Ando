<mat-card class="cardWithShadow">
  <mat-card-content>
    <mat-card-title>Creer un produit</mat-card-title>
    <mat-card-subtitle>Admin et Boutique</mat-card-subtitle>

    @if (serverError) {
      <div class="p-12 text-error">{{ serverError }}</div>
    }

    <form [formGroup]="form" (ngSubmit)="submit()">
      <div class="d-flex flex-wrap gap-16">
        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Boutique ID</mat-label>
          <input matInput formControlName="boutiqueId" placeholder="ID boutique" />
          @if (form.get('boutiqueId')?.hasError('required')) {
            <mat-error>La boutique est obligatoire.</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Titre</mat-label>
          <input matInput formControlName="titre" placeholder="Ex: Chemise" />
          @if (form.get('titre')?.hasError('required')) {
            <mat-error>Le titre est obligatoire.</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="d-flex flex-wrap gap-16">
        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Slug</mat-label>
          <input matInput formControlName="slug" placeholder="Ex: chemise" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Categorie</mat-label>
          <input
            matInput
            [value]="selectedCategoryLabel"
            placeholder="Selectionner une categorie"
            readonly
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="openCategoryDialog()"
            [disabled]="isLoadingCategories"
            aria-label="Choisir une categorie"
          >
            <mat-icon>account_tree</mat-icon>
          </button>
          @if (isLoadingCategories) {
            <mat-hint>Chargement des categories...</mat-hint>
          }
          @if (form.get('categorieId')?.hasError('required')) {
            <mat-error>La categorie est obligatoire.</mat-error>
          }
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" rows="4"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Description courte</mat-label>
        <textarea matInput formControlName="descriptionCourte" rows="2"></textarea>
      </mat-form-field>

      <div class="d-flex flex-wrap gap-16">
        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Sous-categories IDs</mat-label>
          <input
            matInput
            formControlName="sousCategoriesIds"
            placeholder="JSON array ou liste separee par des virgules"
          />
          <mat-hint>Ex: ["id1","id2"] ou id1,id2</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Tags</mat-label>
          <input
            matInput
            formControlName="tags"
            placeholder="JSON array ou liste separee par des virgules"
          />
          <mat-hint>Ex: ["promo","new"] ou promo,new</mat-hint>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Attributs</mat-label>
        <textarea
          matInput
          formControlName="attributs"
          rows="3"
          placeholder="JSON array d'attributs"
        ></textarea>
      </mat-form-field>

      <div class="d-flex flex-wrap gap-16">
        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Prix base actuel</mat-label>
          <input matInput type="number" formControlName="prixBaseActuel" />
          @if (form.get('prixBaseActuel')?.hasError('required')) {
            <mat-error>Le prix est obligatoire.</mat-error>
          }
          @if (form.get('prixBaseActuel')?.hasError('min')) {
            <mat-error>Le prix doit etre positif.</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>SKU</mat-label>
          <input matInput formControlName="sku" />
        </mat-form-field>
      </div>

      <div class="d-flex flex-wrap gap-16">
        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Stock quantite</mat-label>
          <input matInput type="number" formControlName="stockQuantite" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Seuil alerte</mat-label>
          <input matInput type="number" formControlName="stockSeuilAlerte" />
        </mat-form-field>
      </div>

      <div class="d-flex flex-wrap gap-16 m-b-16 align-items-center">
        <mat-slide-toggle formControlName="hasVariations">Variations</mat-slide-toggle>
        <mat-slide-toggle formControlName="estActif">Actif</mat-slide-toggle>
      </div>

      <div class="m-b-16">
        <label class="f-w-600 d-block m-b-8">Images</label>
        <input type="file" multiple (change)="onFilesSelected($event)" [disabled]="isSubmitting" />

        @if (selectedImages.length) {
          <div class="m-t-8 d-flex flex-column gap-6">
            @for (file of selectedImages; track file.name; let i = $index) {
              <div class="d-flex align-items-center gap-8">
                <span class="f-s-13">{{ file.name }}</span>
                <button mat-icon-button type="button" (click)="removeFile(i)" aria-label="Retirer">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            }
          </div>
        }
      </div>

      <div class="d-flex gap-12">
        <button mat-flat-button color="primary" type="submit" [disabled]="isSubmitting">
          Creer le produit
        </button>
        <button mat-stroked-button type="button" (click)="resetForm()" [disabled]="isSubmitting">
          Reinitialiser
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
